{include file='/common/header'/}
{block name='css'}
<style>
    .layui-upload-img {
        width: 92px;
        height: 92px;
        margin: 0 10px 10px 0;
    }
</style>
{/block}
{block name='content'}
<div class="layui-fluid">
    <div class="layui-row">
        <form class="layui-form">
            <div class="layui-form-item">
                <label for="title" class="layui-form-label">
                    <span class="x-red">*</span>标题
                </label>
                <div class="layui-input-inline">
                    <input type="text" id="title" name="title" required="" lay-verify="required" autocomplete="off"
                           class="layui-input">
                </div>
                <div class="layui-form-mid layui-word-aux">
                    <span class="x-red">*</span>相册标题--分享时用到
                </div>
            </div>
            <div class="layui-form-item">
                <label for="description" class="layui-form-label">
                    <span class="x-red"></span>相册简介
                </label>
                <div class="layui-input-inline">
                    <input type="text" id="description" name="description" lay-verify="description"
                           autocomplete="off" class="layui-input">

                </div>
                <div class="layui-form-mid layui-word-aux">
                    <span class="x-red">*</span>
                </div>
            </div>
            <div class="layui-form-item">
                <label for="cover-upload" class="layui-form-label">
                    <span class="x-red"></span>相册封面
                </label>
                <div class="layui-upload">
                    <div class="layui-upload-list">
                        <div>
                            <img class="layui-upload-img" src="__ADMIN_IMAGES__/no_img.jpg" id="cover-upload">
                            <span id="cover-text"></span>
                        </div>
                    </div>
                    <input type="hidden" name="cover" value="" id="cover">
                </div>
            </div>
            <div class="layui-form-item">
                <label for="upload-music" class="layui-form-label">
                    <span class="x-red"></span>背景音乐
                </label>

                <div class="layui-upload">
                    <div class="layui-upload-list">
                        <button id="music-upload" type="button" class="layui-btn layui-btn-primary">
                            <i class="layui-icon">&#xe6fc;</i>上传BGM
                        </button>
                    </div>
                    <div class="layui-upload-list">
                        <audio src="" class="layui-hide" controls
                               id="music-controls"></audio>
                        <span id="music-text"></span>
                    </div>
                    <input type="hidden" name="music" value="" id="music">
                </div>

            </div>
            <div class="layui-form-item">
                <label for="upload-album" class="layui-form-label">
                    <span class="x-red"></span>相册内容
                </label>
                <div class="layui-upload">
                    <button type="button" class="layui-btn layui-btn-normal" id="album-list">点击添加</button>
                    <button type="button" class="layui-btn" id="album-list-action">开始上传</button>
                    <table id="album-tbale" class="layui-table layui-hide">
                        <thead>
                        <tr>
                            <th>图片</th>
                            <th>大小</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="album-tbale-list"></tbody>
                    </table>
                </div>

                <div class="layui-upload-list" id="show-album"></div>
                <input type="hidden" name="full_path" value="" id="full-path">
            </div>
            <div class="layui-form-item">
                <label for="add" class="layui-form-label">
                </label>
                <button class="layui-btn" lay-filter="add" lay-submit="">
                    增加
                </button>
            </div>
        </form>
    </div>
</div>
{/block}
{block name='js'}
<script>
    layui.use(['form', 'layer', 'upload', 'element'],
        function () {
            $ = layui.jquery;
            var form = layui.form,
                layer = layui.layer,
                upload = layui.upload,
                url = "{:url('fileUpload')}",
                element = layui.element;
            var base64_result;
            //封面上传
            var uploadInst = upload.render({
                elem: '#cover-upload'
                , url: url
                , multiple: false
                , number: 1
                , accept: 'images'
                , acceptMime: 'image/*'
                , before: function (obj) {
                    //预读本地文件示例，不支持ie8
                    console.log(obj);
                    obj.preview(function (index, file, result) {
                        // $('#cover-upload').attr('src', result); //图片链接（base64）
                        base64_result = result;
                    });

                }
                , done: function (res, index, upload) {
                    var cover_text = $('#cover-text');
                    if (res.code != '000000') {
                        cover_text.css('color', '#FF5722').css('position', 'relative').css('left', '-100px').prop('id', 'cover-reload').html('上传失败');
                        cover_text.find('#cover-reload').on('click', function () {
                            uploadInst.upload();
                        });
                        return false;
                    } else {
                        // 表示上传成功
                        cover_text.css('color', '#FF5722').css('position', 'relative').css('left', '-100px').html('点击可重新上传');
                        var local_url = res.data.localUrl;
                        $("#cover").val(local_url);
                        $('#cover-upload').attr('src', base64_result);
                        base64_result = '';
                    }
                    //上传成功
                }
                , error: function () {
                    //演示失败状态，并实现重传
                    // var demo_text = $('#cover-text');
                    // demo_text.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                    // demo_text.find('.demo-reload').on('click', function () {
                    //     uploadInst.upload();
                    // });
                }
            });
            //背景音乐上传
            var uploadInst = upload.render({
                elem: '#music-upload'
                , url: url
                , multiple: false
                , number: 1
                , accept: 'audio'
                , acceptMime: 'audio/*'
                , before: function (obj) {
                    //预读本地文件示例，不支持ie8
                    console.log(obj);
                    obj.preview(function (index, file, result) {
                        // $('#cover-upload').attr('src', result); //图片链接（base64）
                        base64_result = result;
                    });

                }
                , done: function (res, index, upload) {
                    console.log(res);
                    console.log(index);
                    console.log(upload);
                    var music_text = $('#music-text');
                    if (res.code != '000000') {
                        music_text.css('color', '#FF5722').css('position', 'relative').css('left', '115px').html('上传失败 <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" id="music-reload" >重新上传</button>');
                        music_text.find('#music-reload').on('click', function () {
                            uploadInst.upload();
                        });
                        return false;
                    } else {
                        // 表示上传成功
                        //music_text.css('color', '#FF5722').css('position', 'relative').css('left', '-100px').html('点击可重新上传');
                        var local_url = res.data.localUrl;
                        $("#music").val(local_url);
                        $("#music-upload").html('<i class="layui-icon">&#xe6fc;</i>重选BGM');
                        $('#music-controls').removeClass('layui-hide').attr('src', base64_result);
                        $('#music-text').html('');
                        base64_result = '';
                    }
                    //上传成功
                }
                , error: function () {
                    // //演示失败状态，并实现重传
                    var music_text = $('#music-text');
                    music_text.css('color', '#FF5722').css('position', 'relative').css('left', '115px').html('上传失败 <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" id="music-reload" >重新上传</button>');
                    music_text.find('#music-reload').on('click', function () {
                        uploadInst.upload();
                    });
                    return false;
                }
            });
            //相册上传
            var full_path = [];
            var uploadInst = $('#album-tbale-list'), uploadListIns = upload.render({
                elem: '#album-list'
                , url: url
                , accept: 'image'
                , multiple: true
                , acceptMime: 'image/*'
                , auto: false
                , bindAction: '#album-list-action'
                , choose: function (obj) {
                    $("#album-tbale").removeClass('layui-hide');
                    var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                    //读取本地文件
                    obj.preview(function (index, file, result) {
                        var tr = $(['<tr id="upload-' + index + '">'
                            , '<td><img class="to-big" style="width: 200px" src="' + result + '" alt=""></td>'
                            , '<td>' + (file.size / 1014).toFixed(1) + 'kb</td>'
                            , '<td>等待上传</td>'
                            , '<td>'
                            , '<button type="button" class="layui-btn layui-btn-xs album-reload layui-hide">重传</button>'
                            , '<button type="button" class="layui-btn layui-btn-xs layui-btn-danger album-delete">删除</button>'
                            , '</td>'
                            , '</tr>'].join(''));
                        //单个重传
                        tr.find('.album-reload').on('click', function () {
                            obj.upload(index, file);
                        });

                        //删除
                        tr.find('.album-delete').on('click', function () {
                            delete files[index]; //删除对应的文件
                            tr.remove();
                            uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                        });

                        uploadInst.append(tr);
                    });
                }
                , done: function (res, index, upload) {
                    if (res.code == '000000') { //上传成功
                        var tr = uploadInst.find('tr#upload-' + index)
                            , tds = tr.children();
                        tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
                        tds.eq(3).html(''); //清空操作
                        full_path.push(res.data.localUrl);
                        $("#full-path").val(full_path);
                        return delete this.files[index]; //删除文件队列已经上传成功的文件
                    } else {
                        this.error(index, upload);
                    }

                }
                , error: function (index, upload) {
                    var tr = uploadInst.find('tr#upload-' + index)
                        , tds = tr.children();
                    tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                    tds.eq(3).find('.album-reload').removeClass('layui-hide'); //显示重传
                }
            });

            //监听提交
            form.on('submit(add)', function (data) {
                var url = "{:url('add')}";
                var datas = data.field;
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: datas,
                    dataType: 'JSON',
                    success: function (res) {
                        //请求成功
                        if (res.code == '000000') {
                            layer.msg(res.msg, {shift: -1, time: 2000, icon: 6}, function () {
                                //关闭当前frame
                                xadmin.close();
                                // 可以对父窗口进行刷新
                                xadmin.father_reload();
                            });
                        } else {
                            layer.msg(res.msg, {shift: -1, time: 2000, icon: 5}, function () {
                            });

                        }
                    },
                });
                return false;
            });

            $(document).on('click', '.to-big', function () {
                var url = $(this).attr('src');
                var img_html = "<img style='width: 100%' src='" + url + "'/>";
                layer.open(
                    {
                        type: 1,
                        title: false,
                        content: img_html,
                        closeBtn: 2,
                        anim: 2,
                    }
                )
            });

        });
</script>
{/block}