{include file='/common/header'/}
{block name='css'}
<style>
    .layui-upload-img {
        width: 92px;
        height: 92px;
        margin: 0 10px 10px 0;
    }
</style>
{/block}
{block name='content'}
<div class="layui-fluid">
    <div class="layui-row">
        <form class="layui-form">
            <div style="padding: 20px; background-color: #F2F2F2;">
                <div class="layui-row layui-col-space15">
                    <!-- <div class="layui-col-md12">
                         <div class="layui-card">
                             <div class="layui-card-header">标题</div>
                             <div class="layui-card-body">
                                 内容
                             </div>
                         </div>
                     </div>-->
                    <!--  <div class="layui-col-md6">
                          <div class="layui-card">
                              <div class="layui-card-header">卡片面板</div>
                              <div class="layui-card-body">
                                  结合 layui 的栅格系统<br>
                                  轻松实现响应式布局
                              </div>
                          </div>
                      </div>-->
                    <div class="layui-col-md12">
                        <div class="layui-card">
                            <div class="layui-card-header">
                                <input type="checkbox" lay-skin="primary" lay-filter="checkall" name="all"
                                       id="check-all">全选
                                <button type="button" class="layui-btn layui-btn-disabled" id="del-all">删除</button>
                            </div>
                        </div>
                    </div>
                    {foreach $row as $k=>$v}
                    <div class="layui-col-md3" id="img-box-{$v.id}">
                        <div class="layui-card">
                            <div class="layui-card-body">
                                <input type="checkbox" data-id="{$v.id}" value="{$v.id}" id="checkbox-{$v.id}"
                                       class="item-checkbox" lay-filter="itemcheckbox"
                                       lay-skin="primary">
                                <img src="{if isset($v.full_path_tmp)}{$v.full_path_tmp}{else/}\{$v.full_path}{/if}"
                                     style="width: 100px;height: 100px;" class="to-big"
                                     alt="">
                                <button type="button" class="layui-btn layui-btn-sm del" data-id="{$v.id}"
                                        data-checkbox-id="checkbox-{$v.id}">删除
                                </button>
                            </div>
                        </div>
                    </div>
                    {/foreach}
                </div>
            </div>
            <!--<div class="layui-form-item">
                <label class="layui-form-label">
                    <span class="x-red"></span>相册内容
                </label>
                <div class="layui-upload">
                    <button type="button" class="layui-btn layui-btn-normal" id="album-list">点击添加</button>
                    <button type="button" class="layui-btn" id="album-list-action">开始上传</button>
                    <table id="album-tbale" class="layui-table layui-hide">
                        <thead>
                        <tr>
                            <th>图片</th>
                            <th>大小</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                        </thead>
                        <tbody id="album-tbale-list"></tbody>
                    </table>
                </div>

                <div class="layui-upload-list" id="show-album"></div>
                <input type="hidden" name="full_path" value="" id="full-path">
            </div>-->
        </form>
    </div>
</div>
{/block}
{block name='js'}
<script>
    layui.use(['form', 'layer', 'upload', 'element'], function () {
        $ = layui.jquery;
        var form = layui.form,
            layer = layui.layer,
            upload = layui.upload,
            url = "{:url('fileUpload')}";
        var base64_result;
        //相册上传
        var full_path = [];
        var uploadInst = $('#album-tbale-list'), uploadListIns = upload.render({
            elem: '#album-list'
            , url: url
            , accept: 'image'
            , multiple: true
            , acceptMime: 'image/*'
            , auto: false
            , bindAction: '#album-list-action'
            , choose: function (obj) {
                $("#album-tbale").removeClass('layui-hide');
                var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                //读取本地文件
                obj.preview(function (index, file, result) {
                    var tr = $(['<tr id="upload-' + index + '">'
                        , '<td><img class="to-big" style="width: 200px" src="' + result + '" alt=""></td>'
                        , '<td>' + (file.size / 1014).toFixed(1) + 'kb</td>'
                        , '<td>等待上传</td>'
                        , '<td>'
                        , '<button type="button" class="layui-btn layui-btn-xs album-reload layui-hide">重传</button>'
                        , '<button type="button" class="layui-btn layui-btn-xs layui-btn-danger album-delete">删除</button>'
                        , '</td>'
                        , '</tr>'].join(''));
                    //单个重传
                    tr.find('.album-reload').on('click', function () {
                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.album-delete').on('click', function () {
                        delete files[index]; //删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                    });

                    uploadInst.append(tr);
                });
            }
            , done: function (res, index, upload) {
                if (res.code == '000000') { //上传成功
                    var tr = uploadInst.find('tr#upload-' + index)
                        , tds = tr.children();
                    tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
                    tds.eq(3).html(''); //清空操作
                    full_path.push(res.data.localUrl);
                    $("#full-path").val(full_path);
                    return delete this.files[index]; //删除文件队列已经上传成功的文件
                } else {
                    this.error(index, upload);
                }

            }
            , error: function (index, upload) {
                var tr = uploadInst.find('tr#upload-' + index)
                    , tds = tr.children();
                tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                tds.eq(3).find('.album-reload').removeClass('layui-hide'); //显示重传
            }
        });
        //全选
        form.on('checkbox(checkall)', function (data) {
            // console.log(data.elem); //得到checkbox原始DOM对象
            // console.log(data.elem.checked); //是否被选中，true或者false
            // console.log(data.value); //复选框value值，也可以通过data.elem.value得到
            // console.log(data.othis); //得到美化后的DOM对象
            var checked = data.elem.checked;
            if (checked) {
                $(".item-checkbox").prop("checked", true);
                $("#del-all").removeClass('layui-btn-disabled');
            } else {
                $(".item-checkbox").prop("checked", false);
                $("#del-all").addClass('layui-btn-disabled');
            }
            form.render();
        });
        //图片放大
        $(document).on('click', '.to-big', function () {
            var url = $(this).attr('src');
            var img_html = "<img id='big-img' style='width: 100%;height: 100%' src='" + url + "'/>";
            layer.open(
                {
                    type: 1,
                    title: false,
                    content: img_html,
                    closeBtn: 2,
                    anim: 2,
                    resize: true,
                    area: ['50%', '60%'],
                }
            )
        });
        //单个删除
        $(document).on('click', '.del', function () {
            var checkbox_id = $(this).data('checkbox-id');
            var id = $(this).data('id');
            if (id == '') {
                id = $("#" + checkbox_id).val();
            }
            var obj = $("#img-box-" + id);
            console.log(obj);

            delItem(id, obj);
        });
        //批量删除
        $("#del-all").click(function () {
            //获取被选中的checkbox
            layer.confirm('确定删除选中项吗？', function () {
                $(".item-checkbox:checked").each(function (k, v) {
                    var obj = $(v);
                    var id = obj.val();
                    var div_obj = $("#img-box-" + id);
                    delItem(id, div_obj);
                });
            })

        });
        //多个选中 按钮禁用取消
        form.on('checkbox(itemcheckbox)', function (data) {
            //判断选中数量是否大于0 大于0 则按钮开放
            var length = $(".item-checkbox:checked").length;
            if (length > 0) {
                $("#del-all").removeClass('layui-btn-disabled');
            } else {
                $("#del-all").addClass('layui-btn-disabled');
            }
            form.render();
        });
        //删除函数
        function delItem(id, obj) {
            $.ajax({
                url: "{:url('delItem')}",
                type: "POST",
                data: {id: id},
                success: function (res) {
                    if (res.code == '000000') {
                        layer.msg(res.msg);
                        obj.remove();
                    } else {
                        layer.msg(res.msg);
                        return false;
                    }
                }
            });
        }
        //滚动放大 缩小
        /*$(document).on("mousewheel DOMMouseScroll", "#big-img", function (e) {
            //"#big-img",
            var parent_width = $(this).parents('.layui-layer-content').width();
            var parent_height = $(this).parents('.layui-layer-content').height();
            var type = e.originalEvent.deltaY;
            var data =parseInt(type);
            if (data > 0) {
                $(this).parents('.layui-layer-content').width(parent_width -60);
                $(this).parents('.layui-layer-content').height(parent_height - 60);
            }
            //向上滚动
            if (data < 0) {
                $(this).parents('.layui-layer-content').width(parent_width + 60);
                $(this).parents('.layui-layer-content').height(parent_height + 60);
            }
        });

        function MouseWheelHandler(e, obj) {
            var e = window.event || e; // old IE support
            var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
            obj.width(Math.max(50, Math.min(1800, obj.width() + (30 * delta))) + "px");
            return false;
        }*/

    });

</script>
{/block}